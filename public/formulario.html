<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radial Training</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

        :root {
            --brand-blue: #0d47a1;
            --brand-blue-dark: #0a3578;
            --brand-orange: #ff6b00;
            --brand-bg: #f2f4f8;
            --card-radius: 16px;
            --shadow-soft: 0 12px 30px rgba(0, 0, 0, 0.14);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--brand-blue) 0%, var(--brand-blue-dark) 70%);
            min-height: 100vh;
            padding: 22px;
            color: #1f2a44;
        }

        .container {
            max-width: 640px;
            margin: 0 auto 28px;
            background: white;
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-soft);
            padding: 28px;
            border: 1px solid #e5eaf2;
        }

        .logo {
            text-align: center;
            margin-bottom: 26px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 14px;
        }

        .logo .logo-wrapper {
            background: var(--brand-blue);
            padding: 14px;
            border-radius: 14px;
            display: inline-flex;
            box-shadow: 0 8px 20px rgba(13, 71, 161, 0.22);
        }

        .logo img {
            height: 56px;
            width: auto;
            max-width: 100%;
            display: block;
        }

        .logo h1 {
            color: var(--brand-blue);
            font-size: 1.6em;
            margin: 0;
            letter-spacing: 0.3px;
        }

        .treinamento-info {
            background: #f7f9fc;
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 26px;
            border-left: 4px solid var(--brand-blue);
        }

        .treinamento-info h2 {
            color: #333;
            font-size: 1.4em;
            margin-bottom: 10px;
        }

        .treinamento-info p {
            color: #666;
            margin: 5px 0;
        }

        /* Progress Steps */
        .steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 26px;
            position: relative;
        }

        .steps::before {
            content: '';
            position: absolute;
            top: 18px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e0e6f0;
            z-index: 0;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .step-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #e5eaf2;
            color: #7a889f;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-weight: 700;
            transition: all 0.25s ease;
            border: 1.5px solid #d5deec;
        }

        .step.active .step-circle {
            background: var(--brand-blue);
            color: white;
            border-color: var(--brand-blue);
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(13, 71, 161, 0.25);
        }

        .step.completed .step-circle {
            background: #1fbf75;
            color: white;
            border-color: #1fbf75;
        }

        .step-label {
            font-size: 12px;
            color: #5a6783;
            font-weight: 600;
        }

        .step.active .step-label {
            color: var(--brand-blue);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 7px;
            color: #2f3d57;
            font-weight: 600;
            font-size: 0.97em;
        }

        .required {
            color: #e74c3c;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 13px;
            border: 1.5px solid #d7deea;
            border-radius: 12px;
            font-size: 15px;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: #fbfcff;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--brand-blue);
            box-shadow: 0 0 0 3px rgba(13, 71, 161, 0.14);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .avaliacao-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 30px 0;
        }

        .avaliacao-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .rating-group {
            margin-bottom: 20px;
        }

        .rating-label {
            display: block;
            margin-bottom: 10px;
            color: #555;
            font-weight: 500;
        }

        .stars {
            display: flex;
            gap: 5px;
            font-size: 30px;
        }

        .star {
            cursor: pointer;
            color: #ddd;
            transition: color 0.2s;
        }

        .star:hover,
        .star.active {
            color: #ffd700;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--brand-blue) 0%, var(--brand-blue-dark) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 10px 20px rgba(13, 71, 161, 0.2);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 14px 26px rgba(13, 71, 161, 0.25);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--brand-orange) 0%, #ff7f1c 100%);
            box-shadow: 0 12px 24px rgba(255, 107, 0, 0.28);
        }

        .sucesso {
            background: #e4f6ed;
            color: #1f7a4d;
            padding: 18px;
            border-radius: 12px;
            text-align: center;
            margin-top: 18px;
            border: 1px solid #c9ebd7;
        }

        .erro {
            background: #fde8ea;
            color: #a12c3a;
            padding: 18px;
            border-radius: 12px;
            text-align: center;
            margin-top: 18px;
            border: 1px solid #f6c6cd;
        }

        .info-box {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #0056B3;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hide {
            display: none !important;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            .logo h1 {
                font-size: 1.5em;
            }

            .step-label {
                font-size: 10px;
            }
        }

        /* Estilos para branding Radial */
        .radial-branding {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #0056b3;
            font-size: 14px;
        }

        .radial-branding h4 {
            color: #0056b3;
            font-size: 16px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radial-branding p {
            color: #495057;
            margin: 5px 0;
            line-height: 1.5;
        }

        .radial-branding a {
            color: #0056b3;
            text-decoration: none;
            font-weight: 500;
        }

        .radial-branding a:hover {
            text-decoration: underline;
        }

        .whatsapp-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .whatsapp-section h4 {
            color: #333;
            font-size: 15px;
            margin-bottom: 15px;
            text-align: center;
        }

        .whatsapp-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .whatsapp-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 20px;
            background: #FF5722;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
            font-size: 14px;
        }

        .whatsapp-btn:hover {
            background: #E64A19;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 87, 34, 0.3);
        }

        .whatsapp-btn span {
            font-size: 20px;
        }

        @media (max-width: 600px) {
            .radial-branding {
                font-size: 13px;
                padding: 15px;
            }

            .whatsapp-btn {
                font-size: 13px;
                padding: 10px 15px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 12px;
            }

            .container {
                padding: 16px;
                border-radius: 14px;
            }

            .logo {
                flex-direction: column;
                gap: 8px;
            }

            .logo h1 {
                font-size: 1.3em;
            }

            .steps {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            .steps::before {
                display: none;
            }

            .step {
                display: flex;
                align-items: center;
                gap: 10px;
                text-align: left;
            }

            .step-circle {
                margin: 0;
            }

            .step-label {
                font-size: 11px;
            }
        }

        /* Modal LGPD */
        .modal-lgpd {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
        }

        .modal-lgpd.show {
            display: flex;
        }

        .modal-lgpd-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-lgpd h2 {
            color: #0056B3;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-lgpd h3 {
            color: #333;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .modal-lgpd p, .modal-lgpd ul {
            color: #555;
            line-height: 1.6;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .modal-lgpd ul {
            padding-left: 25px;
        }

        .modal-lgpd li {
            margin-bottom: 8px;
        }

        .modal-lgpd strong {
            color: #333;
        }

        .lgpd-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin: 25px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }

        .lgpd-checkbox input[type="checkbox"] {
            margin-top: 3px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .lgpd-checkbox label {
            cursor: pointer;
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .lgpd-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-lgpd-accept {
            flex: 1;
            padding: 12px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-lgpd-accept:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .btn-lgpd-accept:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-lgpd-decline {
            flex: 1;
            padding: 12px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-lgpd-decline:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .lgpd-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
            font-size: 12px;
            color: #6c757d;
            text-align: center;
        }

        /* Banner de Vit√≥ria */
        .modal-vitoria {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0, 86, 179, 0.95) 0%, rgba(0, 61, 130, 0.95) 100%);
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.5s ease-in;
        }

        .modal-vitoria.show {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .vitoria-content {
            background: white;
            padding: 50px 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            animation: bounceIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            70% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        .trofeu {
            font-size: 80px;
            margin: 20px 0;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-20px);
            }
        }

        .vitoria-content h2 {
            color: #0056B3;
            font-size: 2em;
            margin: 15px 0;
            font-weight: 700;
        }

        .vitoria-content p {
            color: #666;
            font-size: 1.1em;
            margin: 15px 0;
            line-height: 1.6;
        }

        .vitoria-radial {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 15px;
            margin: 25px 0;
            border: 2px solid #0056B3;
        }

        .vitoria-radial h3 {
            color: #0056B3;
            margin: 0 0 10px 0;
            font-size: 1.3em;
        }

        .vitoria-radial p {
            margin: 8px 0;
            font-size: 0.95em;
            color: #555;
        }

        .vitoria-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            justify-content: center;
        }

        .btn-vitoria {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-vitoria-primary {
            background: linear-gradient(135deg, #0056B3 0%, #003d82 100%);
            color: white;
            flex: 1;
        }

        .btn-vitoria-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 86, 179, 0.4);
        }

        .btn-vitoria-secondary {
            background: #f0f0f0;
            color: #333;
            flex: 1;
        }

        .btn-vitoria-secondary:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        .confete {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #FFD700;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- Banner de Vit√≥ria -->
    <div id="bannerVitoria" class="modal-vitoria">
        <div class="vitoria-content">
            <div class="trofeu">üèÜ</div>
            <h2>Parab√©ns!</h2>
            <p>Voc√™ completou com sucesso!</p>
            
            <div class="vitoria-radial">
                <h3>üéì Radial Training</h3>
                <p>Agradecemos sua participa√ß√£o neste treinamento. Sua dedica√ß√£o e engajamento s√£o fundamentais para o sucesso cont√≠nuo da Radial.</p>
                <p style="margin-top: 15px; font-weight: 500; color: #0056B3;">O seu certificado estar√° dispon√≠vel em breve!</p>
            </div>

            <div class="vitoria-buttons">
                <button class="btn-vitoria btn-vitoria-primary" onclick="fecharBannerVitoria()">Continuar</button>
            </div>
        </div>
    </div>

    <!-- Modal LGPD -->
    <div id="modalLGPD" class="modal-lgpd">
        <div class="modal-lgpd-content">
            <h2>üîí Prote√ß√£o de Dados Pessoais - LGPD</h2>
            
            <p>Prezado(a) participante, antes de prosseguir com seu cadastro, √© importante que voc√™ leia e compreenda como trataremos seus dados pessoais:</p>

            <h3>üìã Dados Coletados</h3>
            <ul>
                <li><strong>Dados pessoais:</strong> Nome completo, e-mail, telefone</li>
                <li><strong>Dados profissionais:</strong> Fun√ß√£o, √°rea, empresa</li>
                <li><strong>Avalia√ß√µes:</strong> Notas e sugest√µes sobre o treinamento</li>
                <li><strong>Dados de acesso:</strong> Data/hora de cadastro e presen√ßa</li>
                <li><strong>Imagens:</strong> Fotografias e v√≠deos realizados durante o treinamento</li>
            </ul>

            <h3>üéØ Finalidade</h3>
            <p>Seus dados ser√£o utilizados exclusivamente para:</p>
            <ul>
                <li>Gerenciamento e controle de presen√ßa no treinamento</li>
                <li>Emiss√£o de certificados de participa√ß√£o</li>
                <li>Avalia√ß√£o da qualidade dos treinamentos</li>
                <li>Comunica√ß√£o sobre o evento</li>
                <li>Divulga√ß√£o institucional (imagens/v√≠deos) em materiais promocionais da Radial</li>
            </ul>

            <h3>‚öñÔ∏è Base Legal</h3>
            <p>O tratamento dos seus dados pessoais est√° fundamentado no <strong>consentimento expresso</strong> (Art. 7¬∫, I da Lei n¬∫ 13.709/2018 - LGPD).</p>

            <h3>üïê Prazo de Guarda</h3>
            <p>Seus dados ser√£o mantidos por at√© <strong>5 anos</strong> ap√≥s o t√©rmino do treinamento, ou enquanto necess√°rio para cumprimento de obriga√ß√µes legais.</p>

            <h3>‚úÖ Seus Direitos (Art. 18 da LGPD)</h3>
            <p>Voc√™ tem o direito de:</p>
            <ul>
                <li>Confirmar a exist√™ncia de tratamento dos seus dados</li>
                <li>Acessar seus dados pessoais</li>
                <li>Corrigir dados incompletos, inexatos ou desatualizados</li>
                <li>Solicitar a anonimiza√ß√£o, bloqueio ou elimina√ß√£o</li>
                <li><strong>Revogar este consentimento a qualquer momento</strong></li>
                <li>Obter informa√ß√µes sobre compartilhamento</li>
                <li>Opor-se ao tratamento realizado com base em seu consentimento</li>
            </ul>

            <h3>üìû Contato</h3>
            <p><strong>Respons√°vel pelo tratamento:</strong> Radial Rolamentos<br>
            <strong>Telefone:</strong> (11) 2174-3700</p>

            <div class="lgpd-checkbox">
                <input type="checkbox" id="aceiteLGPD">
                <label for="aceiteLGPD">
                    <strong>Li e compreendi os termos acima. Concordo com a coleta, tratamento e uso de imagem conforme descrito, e autorizo expressamente o tratamento dos meus dados pessoais pela Radial para as finalidades mencionadas.</strong>
                </label>
            </div>

            <div class="lgpd-buttons">
                <button class="btn-lgpd-decline" onclick="recusarLGPD()">N√£o Aceito</button>
                <button class="btn-lgpd-accept" id="btnAceitarLGPD" onclick="aceitarLGPD()" disabled>Aceito e Continuar</button>
            </div>

            <div class="lgpd-footer">
                Este termo est√° em conformidade com a Lei Geral de Prote√ß√£o de Dados (Lei n¬∫ 13.709/2018)
            </div>
        </div>
    </div>

    <div class="container">
        <div class="logo">
            <div class="logo-wrapper">
                <img src="logo.jpg?t=20251223170400" alt="Logo Radial">
            </div>
            <h1>Radial Training</h1>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Carregando...</p>
        </div>

        <div id="conteudo" class="hide">
            <div class="treinamento-info" id="infoTreinamento"></div>

            <!-- Branding Radial (discreto) -->
            <div class="radial-branding">
                <h4>üè≠ Treinamento oferecido por Radial Rolamentos</h4>
                <p><strong>Desde 1968</strong> fornecendo solu√ß√µes completas em transmiss√£o de pot√™ncia</p>
                <p>üì¶ Maior estoque de produtos industriais da Am√©rica Latina</p>
                <p>üåê <a href="https://rolamentosradial.com.br" target="_blank">rolamentosradial.com.br</a></p>
            </div>

            <!-- WhatsApp Section -->
            <div class="whatsapp-section" id="whatsappSection">
                <h4>üí¨ Fale Conosco via WhatsApp</h4>
                <div class="whatsapp-buttons" id="whatsappButtons">
                    <!-- Bot√µes ser√£o inseridos dinamicamente -->
                </div>
            </div>

            <!-- Progress Steps -->
            <div class="steps">
                <div class="step" id="step1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Cadastro</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Presen√ßa</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Avalia√ß√£o</div>
                </div>
            </div>

            <!-- ETAPA 1: Cadastro -->
            <div id="etapa1" class="hide">
                <h3 style="color: #0056B3; margin-bottom: 20px;">üìù Etapa 1: Cadastro Pr√©-Treinamento</h3>
                
                <!-- Buscar participante por email (padr√£o) -->
                <div id="formBuscarCadastrado" style="display: block;">
                    <div class="info-box">
                        Digite seu e-mail para localizar seu cadastro e confirmar presen√ßa.
                    </div>
                    <form id="formBuscarNome">
                        <div class="form-group">
                            <label>Digite seu E-mail <span class="required">*</span></label>
                            <input type="text" name="email_busca" id="nomeBusca" required placeholder="seu.email@empresa.com.br">
                        </div>
                        <button type="submit" class="btn">üîç Buscar Cadastro</button>
                    </form>
                    <div id="resultadoBusca" class="hide" style="margin-top: 20px;"></div>
                    <div style="margin-top: 20px; text-align: center;">
                        <p style="color: #666; margin-bottom: 10px;">N√£o encontrou seu cadastro?</p>
                        <button type="button" class="btn" onclick="mostrarFormularioCadastro('novo')" style="background: #FF5722;">
                            ‚ûï Fazer Novo Cadastro
                        </button>
                    </div>
                </div>

                <!-- Formul√°rio Novo Cadastro -->
                <div id="formNovoCadastro" class="hide">
                    <div class="info-box">
                        Preencha seus dados para se cadastrar no treinamento.
                    </div>
                    <form id="formCadastro">
                        <div class="form-group">
                            <label>Nome Completo <span class="required">*</span></label>
                            <input type="text" name="nome" required>
                        </div>

                        <div class="form-group">
                            <label>E-mail <span class="required">*</span></label>
                            <input type="email" name="email" required id="emailInput">
                        </div>

                        <div class="form-group">
                            <label>Telefone/Celular <span class="required">*</span></label>
                            <input type="tel" name="telefone" required placeholder="(00) 00000-0000">
                        </div>

                        <div class="form-group">
                            <label>Fun√ß√£o/Cargo <span class="required">*</span></label>
                            <input type="text" name="funcao" required>
                        </div>

                        <div class="form-group">
                            <label>√Årea/Departamento <span class="required">*</span></label>
                            <input type="text" name="area" required>
                        </div>

                        <div class="form-group">
                            <label>Empresa <span class="required">*</span></label>
                            <input type="text" name="empresa_participante" required>
                        </div>

                        <button type="submit" class="btn">‚úÖ Cadastrar e Avan√ßar</button>
                        <button type="button" class="btn" onclick="voltarBusca()" style="background: #555; margin-top: 10px;">‚¨ÖÔ∏è Voltar √† Busca</button>
                    </form>
                </div>
            </div>

            <!-- ETAPA 2: Presen√ßa -->
            <div id="etapa2" class="hide">
                <h3 style="color: #FF5722; margin-bottom: 20px;">‚úã Etapa 2: Confirmar Presen√ßa</h3>
                <div class="info-box">
                    Confirme sua presen√ßa no treinamento.
                </div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <p><strong>Nome:</strong> <span id="nomeParticipante"></span></p>
                    <p><strong>Email:</strong> <span id="emailParticipante"></span></p>
                </div>
                
                <div id="divPin" class="hide" style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                    <label style="color: #856404; margin-bottom: 10px; display: block;">üîê Digite o PIN de Presen√ßa fornecido pelo instrutor</label>
                    <input type="text" id="inputPin" placeholder="Digite o PIN aqui" style="font-size: 18px; letter-spacing: 3px; text-align: center;">
                </div>
                
                <button id="btnPresenca" class="btn btn-success">‚úÖ Confirmar Minha Presen√ßa</button>

                <div style="margin-top: 20px;">
                    <button type="button" class="btn" style="background: #FF5722;" onclick="abrirEdicaoDados()">‚úèÔ∏è Editar meus dados</button>
                </div>

                <div id="formEditarContainer" class="hide" style="margin-top: 15px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h4 style="margin-bottom: 10px; color: #0056B3;">Atualizar cadastro</h4>
                    <form id="formEditarDados">
                        <div class="form-group">
                            <label>Nome Completo</label>
                            <input type="text" name="nome_edit" id="nomeEdit">
                        </div>
                        <div class="form-group">
                            <label>E-mail</label>
                            <input type="email" name="email_edit" id="emailEdit">
                        </div>
                        <div class="form-group">
                            <label>Telefone/Celular</label>
                            <input type="tel" name="telefone_edit" id="telefoneEdit">
                        </div>
                        <div class="form-group">
                            <label>Fun√ß√£o/Cargo</label>
                            <input type="text" name="funcao_edit" id="funcaoEdit">
                        </div>
                        <div class="form-group">
                            <label>√Årea/Departamento</label>
                            <input type="text" name="area_edit" id="areaEdit">
                        </div>
                        <div class="form-group">
                            <label>Empresa</label>
                            <input type="text" name="empresa_edit" id="empresaEdit">
                        </div>
                        <button type="submit" class="btn btn-success">üíæ Salvar altera√ß√µes</button>
                        <button type="button" class="btn" style="background:#555; margin-top:10px;" onclick="fecharEdicaoDados()">Cancelar</button>
                    </form>
                </div>
            </div>

            <!-- ETAPA 3: Avalia√ß√£o -->
            <div id="etapa3" class="hide">
                <h3 style="color: #0056B3; margin-bottom: 20px;">‚≠ê Etapa 3: Avalia√ß√£o do Treinamento</h3>
                <div class="info-box">
                    Avalie o treinamento e deixe suas sugest√µes.
                </div>

                <form id="formAvaliacao">
                    <div class="avaliacao-section">
                        <h3>Avalie de 1 a 5 estrelas</h3>

                        <div class="rating-group">
                            <span class="rating-label">Avalia√ß√£o Geral</span>
                            <div class="stars" data-rating="avaliacao_geral">
                                <span class="star" data-value="1">‚òÖ</span>
                                <span class="star" data-value="2">‚òÖ</span>
                                <span class="star" data-value="3">‚òÖ</span>
                                <span class="star" data-value="4">‚òÖ</span>
                                <span class="star" data-value="5">‚òÖ</span>
                            </div>
                        </div>

                        <div class="rating-group">
                            <span class="rating-label">Conte√∫do Apresentado</span>
                            <div class="stars" data-rating="avaliacao_conteudo">
                                <span class="star" data-value="1">‚òÖ</span>
                                <span class="star" data-value="2">‚òÖ</span>
                                <span class="star" data-value="3">‚òÖ</span>
                                <span class="star" data-value="4">‚òÖ</span>
                                <span class="star" data-value="5">‚òÖ</span>
                            </div>
                        </div>

                        <div class="rating-group">
                            <span class="rating-label">Desempenho do Instrutor</span>
                            <div class="stars" data-rating="avaliacao_instrutor">
                                <span class="star" data-value="1">‚òÖ</span>
                                <span class="star" data-value="2">‚òÖ</span>
                                <span class="star" data-value="3">‚òÖ</span>
                                <span class="star" data-value="4">‚òÖ</span>
                                <span class="star" data-value="5">‚òÖ</span>
                            </div>
                        </div>

                        <div class="rating-group">
                            <span class="rating-label">Material Did√°tico</span>
                            <div class="stars" data-rating="avaliacao_material">
                                <span class="star" data-value="1">‚òÖ</span>
                                <span class="star" data-value="2">‚òÖ</span>
                                <span class="star" data-value="3">‚òÖ</span>
                                <span class="star" data-value="4">‚òÖ</span>
                                <span class="star" data-value="5">‚òÖ</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Sugest√µes e Coment√°rios</label>
                        <textarea name="sugestoes" placeholder="Deixe suas sugest√µes para melhorarmos nossos treinamentos..."></textarea>
                    </div>

                    <button type="submit" class="btn">üéâ Enviar Avalia√ß√£o Final</button>
                </form>
            </div>

            <!-- ETAPA FINAL: Certificado -->
            <div id="etapaFinal" class="hide">
                <button type="button" class="btn" onclick="voltarParaBusca()" style="background: #6c757d; margin-bottom: 20px;">‚Üê Voltar</button>
                <h3 style="color: #2c7a7b; margin-bottom: 20px;">üìú Certificado de Participa√ß√£o</h3>
                <div class="info-box" id="certInfo">
                    Verificando disponibilidade do certificado...
                </div>
                <button id="btnBaixarCert" class="btn btn-success" disabled>‚¨áÔ∏è Baixar Certificado</button>
                <button id="btnRecarregarCert" class="btn" style="margin-top:10px; background:#FF5722; color:white;">üîÑ Verificar Novamente</button>
            </div>

            <!-- Mensagem Final (gen√©rica) -->
            <div id="mensagemFinal" class="hide"></div>
        </div>

        <div id="mensagemErro"></div>
    </div>

    <script>
        let treinamentoId = null;
        let treinamentoCodigo = null;
        let participanteEmail = null;
        let participanteNome = null;
        let etapaAtual = 1;
        let treinamentoData = null;
        let respostaAtualId = null;
        let storageKey = null;
        let lgpdAceito = false;
        let participanteIP = null;

        const ratings = {
            avaliacao_geral: 0,
            avaliacao_conteudo: 0,
            avaliacao_instrutor: 0,
            avaliacao_material: 0
        };

        // Controle do modal LGPD
        document.addEventListener('DOMContentLoaded', function() {
            const checkbox = document.getElementById('aceiteLGPD');
            const btnAceitar = document.getElementById('btnAceitarLGPD');
            
            checkbox.addEventListener('change', function() {
                btnAceitar.disabled = !this.checked;
            });
        });

        function aceitarLGPD() {
            lgpdAceito = true;
            document.getElementById('modalLGPD').classList.remove('show');
            // Obter IP do participante (se dispon√≠vel via API externa ou backend)
            obterIP();
        }

        function recusarLGPD() {
            alert('Para participar do treinamento, √© necess√°rio aceitar o termo de consentimento LGPD.');
        }

        async function obterIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                participanteIP = data.ip;
            } catch (e) {
                participanteIP = 'N√£o dispon√≠vel';
            }
        }

        // Obter c√≥digo do treinamento da URL
        const urlParams = new URLSearchParams(window.location.search);
        treinamentoCodigo = urlParams.get('t');

        // Carregar informa√ß√µes do treinamento
        async function carregarTreinamento() {
            if (!treinamentoCodigo) {
                document.getElementById('loading').innerHTML = '<div class="erro">C√≥digo de treinamento n√£o encontrado!</div>';
                return;
            }

            try {
                const response = await fetch(`/api/treinamentos/${treinamentoCodigo}`);
                const data = await response.json();

                if (response.ok) {
                    treinamentoId = data.id;
                    storageKey = `treinamento:${treinamentoId}:participante`;
                    mostrarInfoTreinamento(data);
                    
                    // N√ÉO mostrar modal LGPD aqui, vai aparecer apenas quando clica em "Novo Cadastro"
                    document.getElementById('loading').classList.add('hide');
                    document.getElementById('conteudo').classList.remove('hide');
                    // Sempre iniciar na Etapa 1 para buscar/selecionar participante
                    mostrarEtapa(1);
                    // Se houver participante salvo, apenas facilitar o preenchimento da busca
                    const salvo = carregarParticipanteLocal();
                    if (salvo && salvo.email) {
                        const campoBusca = document.getElementById('nomeBusca');
                        if (campoBusca) campoBusca.value = salvo.email || '';
                    }
                } else {
                    throw new Error(data.erro);
                }
            } catch (error) {
                document.getElementById('loading').innerHTML = `<div class="erro">Erro: ${error.message}</div>`;
            }
        }

        function mostrarInfoTreinamento(data) {
            treinamentoData = data;
            const dataInicio = data.data ? new Date(data.data).toLocaleDateString('pt-BR') : '';
            const dataFim = data.data_fim ? new Date(data.data_fim).toLocaleDateString('pt-BR') : '';
            const dataLabel = dataFim && dataFim !== dataInicio ? `${dataInicio} at√© ${dataFim}` : dataInicio;

            document.getElementById('infoTreinamento').innerHTML = `
                <h2>${data.titulo}</h2>
                <p><strong>Empresa:</strong> ${data.empresa}</p>
                ${data.empresa_cliente ? `<p><strong>Cliente:</strong> ${data.empresa_cliente}</p>` : ''}
                ${dataLabel ? `<p><strong>Data:</strong> ${dataLabel}</p>` : ''}
                ${data.hora_inicio ? `<p><strong>Hor√°rio:</strong> ${data.hora_inicio}${data.hora_fim ? ' √†s ' + data.hora_fim : ''}</p>` : ''}
                ${data.local ? `<p><strong>Local:</strong> ${data.local}</p>` : ''}
                ${data.instrutor ? `<p><strong>Instrutor:</strong> ${data.instrutor}</p>` : ''}
                <p id="resumoParticipante" style="margin-top: 10px; color: #555;"></p>
            `;

            atualizarResumoParticipante();
            criarBotoesWhatsApp(data);
        }

        function criarBotoesWhatsApp(data) {
            const container = document.getElementById('whatsappButtons');
            let botoesHTML = '';

            // Consolidar TODOS os Instrutores (principal + adicionais)
            let instrutores = [];
            
            // Adicionar instrutor principal se houver
            if (data.instrutor && data.telefone_instrutor) {
                instrutores.push({
                    nome: data.instrutor,
                    telefone: data.telefone_instrutor,
                    tipo: 'instrutor'
                });
            }

            // Adicionar instrutores adicionais
            try {
                const instrutoresAdicionais = JSON.parse(data.instrutores_adicionais || '[]');
                instrutoresAdicionais.forEach(instrutor => {
                    if (instrutor.nome && instrutor.telefone) {
                        instrutores.push({
                            nome: instrutor.nome,
                            telefone: instrutor.telefone,
                            tipo: 'instrutor'
                        });
                    }
                });
            } catch (e) {
                console.log('Erro ao parsear instrutores:', e);
            }

            // Renderizar bot√µes de Instrutores
            instrutores.forEach(instrutor => {
                const tel = instrutor.telefone.replace(/\D/g, '');
                const msg = encodeURIComponent(`Ol√° ${instrutor.nome}, sou participante do treinamento "${data.titulo}". Gostaria de tirar uma d√∫vida.`);
                botoesHTML += `
                    <a href="https://wa.me/55${tel}?text=${msg}" target="_blank" class="whatsapp-btn">
                        <span>üìö</span>
                        Instrutor ${instrutor.nome}
                    </a>
                `;
            });

            // Bot√£o do Representante Comercial
            if (data.telefone_representante && data.nome_representante) {
                const telRepresentante = data.telefone_representante.replace(/\D/g, '');
                const nomeRepresentante = data.nome_representante;
                const mensagemRepresentante = encodeURIComponent(`Ol√° ${nomeRepresentante}, sou participante do treinamento "${data.titulo}". Gostaria de mais informa√ß√µes sobre produtos.`);
                botoesHTML += `
                    <a href="https://wa.me/55${telRepresentante}?text=${mensagemRepresentante}" target="_blank" class="whatsapp-btn">
                        <span>ü§ù</span>
                        Representante ${nomeRepresentante}
                    </a>
                `;
            }

            // T√©cnicos
            try {
                const tecnicos = JSON.parse(data.tecnicos || '[]');
                tecnicos.forEach(tecnico => {
                    if (tecnico.nome && tecnico.telefone) {
                        const tel = tecnico.telefone.replace(/\D/g, '');
                        const msg = encodeURIComponent(`Ol√° ${tecnico.nome}, sou participante do treinamento "${data.titulo}". Preciso de suporte t√©cnico.`);
                        botoesHTML += `
                            <a href="https://wa.me/55${tel}?text=${msg}" target="_blank" class="whatsapp-btn">
                                <span>üîß</span>
                                T√©cnico ${tecnico.nome}
                            </a>
                        `;
                    }
                });
            } catch (e) {
                console.log('Erro ao parsear t√©cnicos:', e);
            }

            // Se n√£o houver nenhum contato, ocultar a se√ß√£o
            if (botoesHTML === '') {
                document.getElementById('whatsappSection').style.display = 'none';
            } else {
                container.innerHTML = botoesHTML;
                document.getElementById('whatsappSection').style.display = 'block';
            }
        }

        function voltarBusca() {
            // Limpar campos do formul√°rio de cadastro
            document.getElementById('formCadastro').reset();
            // Ocultar formul√°rio de novo cadastro
            document.getElementById('formNovoCadastro').classList.add('hide');
            // Mostrar √°rea de busca (garante remo√ß√£o da classe hide)
            const formBuscar = document.getElementById('formBuscarCadastrado');
            formBuscar.classList.remove('hide');
            formBuscar.style.display = 'block';
            // Limpar resultado da busca
            document.getElementById('resultadoBusca').classList.add('hide');
            document.getElementById('resultadoBusca').innerHTML = '';
        }

        function mostrarEtapa(etapa) {
            // Ocultar todas as etapas
            document.getElementById('etapa1').classList.add('hide');
            document.getElementById('etapa2').classList.add('hide');
            document.getElementById('etapa3').classList.add('hide');
            document.getElementById('etapaFinal').classList.add('hide');

            // Atualizar steps
            for (let i = 1; i <= 3; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('active', 'completed');
                if (i < etapa) {
                    step.classList.add('completed');
                } else if (i === etapa) {
                    step.classList.add('active');
                }
            }

            // Mostrar etapa atual
            if (etapa <= 3) {
                document.getElementById(`etapa${etapa}`).classList.remove('hide');
            } else {
                // Esconde os steps visuais e mostra somente o certificado
                document.querySelector('.steps').classList.add('hide');
                document.getElementById('etapaFinal').classList.remove('hide');
            }
            etapaAtual = etapa;
        }

        // ETAPA 1: Cadastro
        document.getElementById('formCadastro').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validar aceite LGPD
            if (!lgpdAceito) {
                alert('Por favor, aceite o termo de consentimento LGPD para continuar.');
                document.getElementById('modalLGPD').classList.add('show');
                return;
            }

            const formData = new FormData(e.target);
            const data = {
                treinamento_id: treinamentoId,
                nome: formData.get('nome'),
                email: formData.get('email'),
                telefone: formData.get('telefone'),
                funcao: formData.get('funcao'),
                area: formData.get('area'),
                empresa_participante: formData.get('empresa_participante'),
                consentimento_lgpd: lgpdAceito,
                consentimento_ip: participanteIP || 'N√£o dispon√≠vel'
            };

            participanteEmail = data.email;
            participanteNome = data.nome;
            salvarParticipanteLocal();
            atualizarResumoParticipante();

            try {
                const response = await fetch('/api/cadastro', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    document.getElementById('nomeParticipante').textContent = participanteNome;
                    document.getElementById('emailParticipante').textContent = participanteEmail;
                    
                    // Mostrar campo PIN se necess√°rio
                    if (treinamentoData && treinamentoData.exigir_pin) {
                        document.getElementById('divPin').classList.remove('hide');
                    }
                    
                    if (result.ja_cadastrado) {
                        // Verificar status
                        verificarStatus();
                    } else {
                        mostrarEtapa(2);
                    }
                } else {
                    throw new Error(result.erro);
                }
            } catch (error) {
                alert('Erro ao cadastrar: ' + error.message);
            }
        });

        // ETAPA 2: Presen√ßa
        document.getElementById('btnPresenca').addEventListener('click', async () => {
            const pinFornecido = document.getElementById('inputPin').value;
            
            try {
                const response = await fetch('/api/presenca', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        treinamento_id: treinamentoId,
                        email: participanteEmail,
                        pin_fornecido: pinFornecido
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    mostrarEtapa(3);
                } else if (response.status === 401) {
                    alert('‚ùå PIN inv√°lido! Verifique com o instrutor.');
                } else {
                    throw new Error(result.erro);
                }
            } catch (error) {
                alert('Erro ao confirmar presen√ßa: ' + error.message);
            }
        });

        // Sistema de avalia√ß√£o por estrelas
        document.querySelectorAll('.stars').forEach(starsContainer => {
            const ratingName = starsContainer.getAttribute('data-rating');
            const stars = starsContainer.querySelectorAll('.star');

            stars.forEach(star => {
                star.addEventListener('click', () => {
                    const value = parseInt(star.getAttribute('data-value'));
                    ratings[ratingName] = value;

                    stars.forEach((s, index) => {
                        if (index < value) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                });

                star.addEventListener('mouseenter', () => {
                    const value = parseInt(star.getAttribute('data-value'));
                    stars.forEach((s, index) => {
                        if (index < value) {
                            s.style.color = '#ffd700';
                        } else {
                            s.style.color = '#ddd';
                        }
                    });
                });
            });

            starsContainer.addEventListener('mouseleave', () => {
                const currentRating = ratings[ratingName];
                stars.forEach((s, index) => {
                    if (index < currentRating) {
                        s.style.color = '#ffd700';
                    } else {
                        s.style.color = '#ddd';
                    }
                });
            });
        });

        // ETAPA 3: Avalia√ß√£o
        document.getElementById('formAvaliacao').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = {
                treinamento_id: treinamentoId,
                email: participanteEmail,
                avaliacao_geral: ratings.avaliacao_geral,
                avaliacao_conteudo: ratings.avaliacao_conteudo,
                avaliacao_instrutor: ratings.avaliacao_instrutor,
                avaliacao_material: ratings.avaliacao_material,
                sugestoes: formData.get('sugestoes')
            };

            try {
                const response = await fetch('/api/avaliacao', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    // Ap√≥s avalia√ß√£o, mostrar banner de vit√≥ria
                    document.getElementById('step3').classList.add('completed');
                    mostrarBannerVitoria();
                    lancarConfete();
                    // O banner fica vis√≠vel at√© o cliente clicar em "Continuar"
                } else {
                    throw new Error('Erro ao enviar avalia√ß√£o');
                }
            } catch (error) {
                alert('Erro ao enviar avalia√ß√£o: ' + error.message);
            }
        });

        // Verificar status do participante
        async function verificarStatus() {
            try {
                const response = await fetch(`/api/participante/${treinamentoId}/${participanteEmail}`);
                const data = await response.json();

                if (data && data.id) {
                    respostaAtualId = data.id;
                    participanteNome = data.nome || participanteNome;
                    document.getElementById('nomeParticipante').textContent = participanteNome || '';
                    document.getElementById('emailParticipante').textContent = participanteEmail || '';
                    atualizarResumoParticipante();
                    salvarParticipanteLocal();
                }

                if (data.status === 'cadastrado') {
                    // J√° cadastrado, vai para presen√ßa
                    mostrarEtapa(2);
                } else if (data.status === 'presente') {
                    // J√° confirmou presen√ßa, vai para avalia√ß√£o
                    mostrarEtapa(3);
                } else if (data.status === 'avaliado') {
                    // J√° completou tudo: mostrar somente etapa final (certificado)
                    mostrarEtapa(4);
                    atualizarEstadoCertificado();
                }
            } catch (error) {
                // Novo participante, come√ßa na etapa 1
                console.log('Novo participante');
                mostrarEtapa(1);
            }
        }

        function abrirEdicaoDados() {
            // Preencher form com dados atuais
            document.getElementById('formEditarContainer').classList.remove('hide');
            document.getElementById('nomeEdit').value = participanteNome || '';
            document.getElementById('emailEdit').value = participanteEmail || '';
            document.getElementById('telefoneEdit').value = '';
            document.getElementById('funcaoEdit').value = '';
            document.getElementById('areaEdit').value = '';
            document.getElementById('empresaEdit').value = '';
        }

        function fecharEdicaoDados() {
            document.getElementById('formEditarContainer').classList.add('hide');
        }

        document.getElementById('formEditarDados').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!respostaAtualId) {
                alert('Cadastro n√£o localizado para edi√ß√£o.');
                return;
            }

            const nome = document.getElementById('nomeEdit').value || participanteNome || '';
            const email = document.getElementById('emailEdit').value || participanteEmail || '';
            const telefone = document.getElementById('telefoneEdit').value || '';
            const funcao = document.getElementById('funcaoEdit').value || '';
            const area = document.getElementById('areaEdit').value || '';
            const empresa_participante = document.getElementById('empresaEdit').value || '';

            try {
                const resp = await fetch(`/api/respostas/${respostaAtualId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nome, email, telefone, funcao, area, empresa_participante })
                });
                if (resp.ok) {
                    participanteNome = nome;
                    participanteEmail = email;
                    document.getElementById('nomeParticipante').textContent = participanteNome;
                    document.getElementById('emailParticipante').textContent = participanteEmail;
                    atualizarResumoParticipante();
                    salvarParticipanteLocal();
                    alert('Dados atualizados com sucesso.');
                    fecharEdicaoDados();
                } else {
                    const j = await resp.json().catch(() => ({}));
                    alert('Erro ao atualizar: ' + (j.erro || resp.status));
                }
            } catch (err) {
                alert('Erro ao enviar atualiza√ß√£o.');
            }
        });

        async function atualizarEstadoCertificado() {
            const info = document.getElementById('certInfo');
            const btnBaixar = document.getElementById('btnBaixarCert');
            btnBaixar.disabled = true;
            info.textContent = 'Verificando disponibilidade do certificado...';

            try {
                // Consultar status do participante (retorna campo certificado_arquivo se existir)
                const r = await fetch(`/api/participante/${treinamentoId}/${encodeURIComponent(participanteEmail)}`);
                const p = await r.json();
                if (p && p.certificado_arquivo) {
                    info.innerHTML = 'Seu certificado est√° dispon√≠vel para download.';
                    btnBaixar.disabled = false;
                } else {
                    info.innerHTML = 'Seu certificado ainda n√£o est√° dispon√≠vel. Assim que o instrutor publicar, este bot√£o ser√° liberado.';
                    btnBaixar.disabled = true;
                }
            } catch (e) {
                info.innerHTML = 'N√£o foi poss√≠vel verificar o certificado agora.';
                btnBaixar.disabled = true;
            }
        }

        document.getElementById('btnBaixarCert').addEventListener('click', async () => {
            if (!participanteEmail || !treinamentoId) return;
            // Tenta baixar; se n√£o existir, a API responde 404
            window.location.href = `/api/certificado/${treinamentoId}/${encodeURIComponent(participanteEmail)}`;
        });

        document.getElementById('btnRecarregarCert').addEventListener('click', atualizarEstadoCertificado);

        function mostrarFormularioCadastro(tipo) {
            if (tipo === 'novo') {
                document.getElementById('formBuscarCadastrado').classList.add('hide');
                document.getElementById('formNovoCadastro').classList.remove('hide');
                // Mostrar modal LGPD apenas para novo cadastro
                document.getElementById('modalLGPD').classList.add('show');
            } else {
                document.getElementById('formNovoCadastro').classList.add('hide');
                document.getElementById('formBuscarCadastrado').classList.remove('hide');
                // N√ÉO mostrar modal para cadastro existente
                document.getElementById('modalLGPD').classList.remove('show');
            }
        }

        // Buscar participante por email
        document.getElementById('formBuscarNome').addEventListener('submit', async (e) => {
            e.preventDefault();
            const emailBusca = document.getElementById('nomeBusca').value;

            try {
                const response = await fetch(`/api/buscar-participante/${treinamentoId}/${encodeURIComponent(emailBusca)}`);
                const data = await response.json();

                if (response.ok && data.length > 0) {
                    // Mostrar resultados
                    const resultadoDiv = document.getElementById('resultadoBusca');
                    resultadoDiv.innerHTML = '<h4 style="color: #0056B3; margin-bottom: 15px;">Cadastro encontrado:</h4>';
                    
                    data.forEach(participante => {
                        resultadoDiv.innerHTML += `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; border: 2px solid #e0e0e0;" 
                                 onclick="selecionarParticipante('${participante.email}', '${participante.nome}')"
                                 onmouseover="this.style.borderColor='#0056B3'" 
                                 onmouseout="this.style.borderColor='#e0e0e0'">
                                <strong>${participante.nome}</strong><br>
                                <small style="color: #666;">${participante.email} | ${participante.empresa_participante}</small>
                            </div>
                        `;
                    });
                    
                    resultadoDiv.classList.remove('hide');
                } else {
                    alert('‚ùå Nenhum cadastro encontrado com esse e-mail. Verifique a digita√ß√£o ou fa√ßa um novo cadastro.');
                }
            } catch (error) {
                alert('Erro ao buscar cadastro: ' + error.message);
            }
        });

        // Selecionar participante e ir para etapa 2
        function selecionarParticipante(email, nome) {
            participanteEmail = email;
            participanteNome = nome;
            document.getElementById('nomeParticipante').textContent = nome;
            document.getElementById('emailParticipante').textContent = email;
            atualizarResumoParticipante();
            salvarParticipanteLocal();
            
            // Mostrar campo PIN se necess√°rio
            if (treinamentoData && treinamentoData.exigir_pin) {
                document.getElementById('divPin').classList.remove('hide');
            } else {
                document.getElementById('divPin').classList.add('hide');
            }
            
            // Verificar status do participante para ir √† etapa correta
            verificarStatus();
        }

        // Carregar treinamento ao iniciar
        carregarTreinamento();

        function salvarParticipanteLocal() {
            if (!storageKey) return;
            const obj = { email: participanteEmail, nome: participanteNome };
            try { localStorage.setItem(storageKey, JSON.stringify(obj)); } catch {}
        }

        function carregarParticipanteLocal() {
            if (!storageKey) return null;
            try {
                const raw = localStorage.getItem(storageKey);
                return raw ? JSON.parse(raw) : null;
            } catch {
                return null;
            }
        }

        function limparParticipanteLocal() {
            if (!storageKey) return;
            try { localStorage.removeItem(storageKey); } catch {}
        }

        function atualizarResumoParticipante() {
            const resumo = document.getElementById('resumoParticipante');
            if (!resumo) return;
            if (participanteNome || participanteEmail) {
                resumo.innerHTML = `<strong>Participante:</strong> ${(participanteNome || '').trim()} ${participanteEmail ? '(' + participanteEmail + ')' : ''}`;
                resumo.style.display = 'block';
            } else {
                resumo.textContent = '';
                resumo.style.display = 'none';
            }
        }

        // Banner de Vit√≥ria
        function mostrarBannerVitoria() {
            const modal = document.getElementById('bannerVitoria');
            if (modal) {
                modal.classList.add('show');
            }
        }

        function fecharBannerVitoria() {
            const modal = document.getElementById('bannerVitoria');
            if (modal) {
                modal.classList.remove('show');
                // Ap√≥s fechar o banner, ir para etapa final
                mostrarEtapa(4);
                atualizarEstadoCertificado();
            }
        }

        // Efeito de confete
        function lancarConfete() {
            const cores = ['#FFD700', '#FF5722', '#0056B3', '#28a745', '#FF69B4'];
            const quantidadeConfete = 50;

            for (let i = 0; i < quantidadeConfete; i++) {
                setTimeout(() => {
                    const confete = document.createElement('div');
                    confete.className = 'confete';
                    confete.style.left = Math.random() * 100 + '%';
                    confete.style.backgroundColor = cores[Math.floor(Math.random() * cores.length)];
                    confete.style.animation = `caindo ${2 + Math.random() * 1}s linear forwards`;
                    document.body.appendChild(confete);

                    setTimeout(() => confete.remove(), 3000);
                }, i * 30);
            }
        }

        // Adicionar anima√ß√£o de confete ao CSS dinamicamente
        const style = document.createElement('style');
        style.textContent = `
            @keyframes caindo {
                to {
                    transform: translateY(100vh) rotate(360deg);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // Voltar para a tela inicial
        function voltarParaBusca() {
            lgpdAceito = false;
            limparParticipanteLocal();
            participanteEmail = '';
            participanteNome = '';
            respostaAtualId = null;
            mostrarEtapa(1);
            document.getElementById('resultadoBusca').classList.add('hide');
            document.getElementById('resultadoBusca').innerHTML = '';
            document.getElementById('nomeBusca').value = '';
            mostrarFormularioCadastro('buscar');
        }
    </script>

    <!-- Footer -->
    <footer style="text-align: center; padding: 20px; color: #999; font-size: 12px; border-top: 1px solid #eee; margin-top: 40px;">
        <p>Radial Training Platform | By M.Almeida</p>
    </footer>
</body>
</html>
